{% extends 'base.html' %}

{% block title %}Cadastro - GetAgro{% endblock %}

{% block content %}
  <div class="mx-auto max-w-lg rounded-xl border bg-white p-6">
    <h1 class="text-2xl font-semibold">Criar conta</h1>
    <p class="mt-2 text-sm text-gray-600">Escolha se você é comprador ou vendedor e preencha seus dados.</p>

    <form method="post" class="mt-6 space-y-4">
      {% csrf_token %}
      {% if next %}<input type="hidden" name="next" value="{{ next }}" />{% endif %}
      {% if role %}<input type="hidden" name="role" value="{{ role }}" />{% endif %}

      <div>
        <label class="text-sm font-medium">Nome</label>
        <div class="mt-1">{{ form.full_name }}</div>
        {% if form.full_name.errors %}<div class="mt-1 text-sm text-red-600">{{ form.full_name.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">CPF/CNPJ</label>
        <div class="mt-1">{{ form.document }}</div>
        {% if form.document.errors %}<div class="mt-1 text-sm text-red-600">{{ form.document.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">E-mail</label>
        <div class="mt-1">{{ form.email }}</div>
        {% if form.email.errors %}<div class="mt-1 text-sm text-red-600">{{ form.email.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">Telefone/WhatsApp</label>
        <div class="mt-1">{{ form.phone }}</div>
        {% if form.phone.errors %}<div class="mt-1 text-sm text-red-600">{{ form.phone.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">CEP</label>
        <div class="mt-1">{{ form.cep }}</div>
        {% if form.cep.errors %}<div class="mt-1 text-sm text-red-600">{{ form.cep.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">Endereço</label>
        <div class="mt-1">{{ form.address }}</div>
        {% if form.address.errors %}<div class="mt-1 text-sm text-red-600">{{ form.address.errors }}</div>{% endif %}
      </div>

      <div class="grid gap-4 sm:grid-cols-3">
        <div class="sm:col-span-2">
          <label class="text-sm font-medium">Cidade</label>
          <div class="mt-1">{{ form.city }}</div>
          {% if form.city.errors %}<div class="mt-1 text-sm text-red-600">{{ form.city.errors }}</div>{% endif %}
        </div>
        <div>
          <label class="text-sm font-medium">UF</label>
          <div class="mt-1">{{ form.state }}</div>
          {% if form.state.errors %}<div class="mt-1 text-sm text-red-600">{{ form.state.errors }}</div>{% endif %}
        </div>
      </div>

      <div>
        <div class="text-sm font-medium">Tipo de conta</div>
        <div class="mt-2 space-y-2">{{ form.role }}</div>
        {% if form.role.errors %}<div class="mt-1 text-sm text-red-600">{{ form.role.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">Senha</label>
        <div class="mt-1">{{ form.password1 }}</div>
        {% if form.password1.errors %}<div class="mt-1 text-sm text-red-600">{{ form.password1.errors }}</div>{% endif %}
      </div>

      <div>
        <label class="text-sm font-medium">Confirmar senha</label>
        <div class="mt-1">{{ form.password2 }}</div>
        {% if form.password2.errors %}<div class="mt-1 text-sm text-red-600">{{ form.password2.errors }}</div>{% endif %}
      </div>

      <button class="w-full rounded bg-gray-900 px-4 py-2 text-white" type="submit">Criar conta</button>

      <div class="text-center text-sm text-gray-600">
        Já tem conta?
        <a class="font-medium text-gray-900 hover:underline" href="{% url 'accounts:login' %}?role={{ role }}&next={{ next }}">Entrar</a>
      </div>
    </form>
  </div>

  <style>
    input { width: 100%; border: 1px solid rgb(209 213 219); border-radius: 0.5rem; padding: 0.5rem 0.75rem; }
    ul.errorlist { margin-top: 0.25rem; }
    ul.errorlist li { color: rgb(220 38 38); font-size: 0.875rem; }
    #id_role { display: flex; gap: 1rem; }
    #id_role label { display: inline-flex; align-items: center; gap: 0.5rem; }
  </style>

  <script>
    (function () {
      const cepInput = document.getElementById('id_cep');
      const addressInput = document.getElementById('id_address');
      const cityInput = document.getElementById('id_city');
      const stateInput = document.getElementById('id_state');

      if (!cepInput) return;

      function normalizeCep(value) {
        return (value || '').replace(/\D/g, '');
      }

      async function fetchCep(cep) {
        const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`, { method: 'GET' });
        if (!resp.ok) return null;
        const data = await resp.json();
        if (data && data.erro) return null;
        return data;
      }

      function setIfEmpty(input, value) {
        if (!input) return;
        if (input.value && input.value.trim().length > 0) return;
        input.value = value || '';
      }

      let lastCep = null;
      let debounceTimer = null;

      async function handleCepChange() {
        const cep = normalizeCep(cepInput.value);
        if (cep.length !== 8) return;
        if (cep === lastCep) return;
        lastCep = cep;

        try {
          const data = await fetchCep(cep);
          if (!data) return;

          const address = [data.logradouro, data.bairro].filter(Boolean).join(' - ');
          setIfEmpty(addressInput, address);
          setIfEmpty(cityInput, data.localidade);
          setIfEmpty(stateInput, (data.uf || '').toUpperCase());
        } catch (e) {
          return;
        }
      }

      cepInput.addEventListener('input', function () {
        const normalized = normalizeCep(cepInput.value);
        if (normalized !== cepInput.value) {
          const cursor = cepInput.selectionStart;
          cepInput.value = normalized;
          if (typeof cursor === 'number') {
            cepInput.setSelectionRange(cursor, cursor);
          }
        }

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(handleCepChange, 400);
      });

      cepInput.addEventListener('blur', function () {
        handleCepChange();
      });
    })();
  </script>
{% endblock %}
